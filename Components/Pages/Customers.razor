@page "/customers"
@using BankDatabase
@using BankDatabase.Infostructure.Enums
@using BankDatabase.Infostructure.Entities
@using BankDatabase.Infostructure.Repositories
@using BankDatabase.Infostructure.Mappers
@using BankDatabase.Infostructure.Currents
@rendermode InteractiveServer
@inject CustomerRepository customerRepository
@inject ILogger<Customers> Logger
@inject IDialogService DialogService

<MudDialogProvider />
<MudSnackbarProvider />

@if (pageState.Equals(PageState.Default))
{   
    <MudPaper Width="100%" Class="d-flex justify-center align-content-start" Elevation="0">
        <MudTable Items="entities" Hover="true" Elevation="0" 
              Dense="true" Square="true" Height="700"
              Loading="@isLoading" Style="margin-top:20px; width:1000px;">
            <ToolBarContent>
                <MudIconButton Disabled="isLoading" Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" OnClick="@(() => Refresh())"></MudIconButton>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Id</MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Phone Number</MudTh>
                <MudTh>Email Address</MudTh>
                <MudTh Style="text-align:right;">
                    <MudIconButton Disabled="isLoading" Icon="@Icons.Material.Filled.Add" Size="Size.Small" OnClick="@(() => Add())"/>
                </MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Id</MudTd>
                <MudTd>@context.Name</MudTd>
                <MudTd>@context.PhoneNumber</MudTd>
                <MudTd>@context.EmailAddress</MudTd>
                <MudTd Style="text-align:right;">
                    <MudIconButton Disabled="isLoading" Size="Size.Small" Icon="@Icons.Material.Filled.Edit" OnClick="@(() => StartEdit(context))" Class="ml-auto"/>
                    <MudIconButton Disabled="isLoading" Size="Size.Small" Icon="@Icons.Material.Filled.Delete" OnClick="@(() => Delete(context))" Class="ml-auto"/>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
}
else
{
    <MudPaper Width="100%" Class="d-flex justify-center align-content-start" Elevation="0">
        <MudPaper Elevation="0" Style="margin-top:20px; width:1000px;">
            <MudStack Row="true">
                <EditForm Model="@current" OnValidSubmit="@(() => Submit())">
                    @if (pageState.Equals(PageState.Add))
                    {
                        <MudText Typo="Typo.h5">Add Customer</MudText>
                    }
                    else if (pageState.Equals(PageState.Edit))
                    {
                        <MudText Typo="Typo.h5">Edit Customer</MudText>
                        <MudTextField Margin="Margin.Dense" Style="width:300px;" ReadOnly="true" Variant="Variant.Outlined" Label="Id" @bind-Value="@current.Id" />
                    }
                    <DataAnnotationsValidator />
                    <MudTextField Margin="Margin.Dense" Style="width:300px;" 
                                  Variant="Variant.Outlined" 
                                  For="@(() => current.Name)"
                                  Label="Name" @bind-Value="@current.Name" Class="mt-3" />
                    <MudTextField Margin="Margin.Dense" Style="width:300px;"
                                  Variant="Variant.Outlined" 
                                  HelperText="+373 xx xxx xxx"
                                  Mask="@(new PatternMask("00 000 000"))"
                                  For="@(() => current.PhoneNumber)"
                                  Label="Phone Number" @bind-Value="@current.PhoneNumber" Class="mt-3" />
                    <MudTextField Margin="Margin.Dense" Style="width:300px;"
                                  Variant="Variant.Outlined" 
                                  For="@(() => current.EmailAddress)"
                                  Label="Email Address" @bind-Value="@current.EmailAddress" Class="mt-3" />
                    <MudStack Row="true" Spacing="3" Class="mt-3">
                        <MudButton OnClick="@(() => Cancel())" Variant="Variant.Filled" Color="Color.Primary">Cancel</MudButton>
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">
                            @if (pageState.Equals(PageState.Add))
                            {
                                <MudText Typo="Typo.button">Add</MudText>
                            }
                            else if (pageState.Equals(PageState.Edit)) 
                            {
                                <MudText Typo="Typo.button">Edit</MudText>
                            }
                        </MudButton>
                    </MudStack>
                </EditForm>
            </MudStack>
        </MudPaper>
    </MudPaper>
}

@code {
    private PageState pageState;
    private bool isLoading = false;
    private List<CustomerEntity> entities = new List<CustomerEntity>();
    private CurrentCustomer current = new CurrentCustomer();
    private CustomerMapper mapper = new CustomerMapper();

    protected override async Task OnInitializedAsync()
    {
        pageState = PageState.Default;

        await UpdateLocalData();
    }

    private async Task Submit()
    {
        switch (pageState)
        {
            case PageState.Add: await Add(); break;
            case PageState.Edit: await ContinueEdit(); break;
        }
    }

    private async Task Add()
    {
        if (pageState.Equals(PageState.Default))
        {
            pageState = PageState.Add;
        }
        else if (pageState.Equals(PageState.Add))
        {
            var dialog = await OpenDialog(Dialog.ConfirmAdd);

            if (!dialog?.Canceled ?? false) 
            {
                try
                {
                    var entity = new CustomerEntity();

                    mapper.ApplyToEntity(entity, current);

                    customerRepository.Add(entity);

                    await UpdateLocalData();
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex.StackTrace + Environment.NewLine + ex.Message);
                }

                DisposeUI();
            }

        }

    }

    private void StartEdit(CustomerEntity entity)
    {
        if (pageState.Equals(PageState.Default))
        {
            current = mapper.ToCurrent(entity);

            pageState = PageState.Edit;
        }
    }

    private async Task ContinueEdit()
    {
        if (pageState.Equals(PageState.Edit))
        {
            var dialog = await OpenDialog(Dialog.ConfirmEdit);

            if (!dialog?.Canceled ?? false)
            {
                try
                {
                    var entity = entities.First(x => x.Id == current.Id);

                    mapper.ApplyToEntity(entity, current);

                    customerRepository.Update(entity);

                    await UpdateLocalData();

                    StateHasChanged();
                }
                catch (Exception ex) 
                {
                    Logger.LogError(ex.StackTrace + Environment.NewLine + ex.Message);
                }

                DisposeUI();
            }
        }
    }

    private async Task Delete(CustomerEntity entity)
    {
        var dialog = await OpenDialog(Dialog.ConfirmDelete);

        if (!dialog?.Canceled ?? false)
        {
            customerRepository.Delete(entity);
            await UpdateLocalData();
        }
    }

    private async Task Cancel()
    {
        var dialog = await OpenDialog(Dialog.ConfirmCancel);

        if (!dialog?.Canceled ?? false)
        {
            DisposeUI();
        }
    }

    private async Task Refresh()
    {
        await UpdateLocalData();
    }

    private async Task UpdateLocalData()
    {
        isLoading = true;
        
        entities = customerRepository.GetAll();

        isLoading = false;

        await InvokeAsync(StateHasChanged);
    }

    private void DisposeUI()
    {
        pageState = PageState.Default;

        current = new CurrentCustomer();

        StateHasChanged();
    }

    public async Task<DialogResult?> OpenDialog(Dialog dialog)
    {
        IDialogReference window = default!;

        switch (dialog)
        {
            case Dialog.ConfirmAdd: window = await DialogService.ShowAsync<Dialogs.ConfirmAdd>(); break;
            case Dialog.ConfirmEdit: window = await DialogService.ShowAsync<Dialogs.ConfirmEdit>(); break;
            case Dialog.ConfirmDelete: window = await DialogService.ShowAsync<Dialogs.ConfirmDelete>(); break;
            case Dialog.ConfirmCancel: window = await DialogService.ShowAsync<Dialogs.ConfirmCancel>(); break;
        }

        var result = await window.Result;

        return result;
    }
}
