@page "/customers"
@using BankDatabase
@using BankDatabase.Enums
@using BankDatabase.Entities
@using BankDatabase.Repositories
@using BankDatabase.Abstractions.Cron;
@using System.ComponentModel.DataAnnotations
@rendermode InteractiveServer
@inject CustomerRepository customerRepository
@inject ILogger<Customers> Logger
@inject IDialogService DialogService

<MudDialogProvider />
<MudSnackbarProvider />

@if (pageState.Equals(PageState.Default))
{   
    <MudTable Items="customers" Hover="true" Elevation="0" 
              Dense="true" Square="true" Height="700" Loading="@isLoading" Style="width:1000px;">
        <ToolBarContent>
            <MudIconButton Disabled="isLoading" Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" OnClick="@(() => Refresh())"></MudIconButton>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Id</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Phone Number</MudTh>
            <MudTh>Email Address</MudTh>
            <MudTh Style="text-align:right;">
                <MudIconButton Disabled="isLoading" Icon="@Icons.Material.Filled.Add" Size="Size.Small" OnClick="@(() => Add())"/>
            </MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Id</MudTd>
            <MudTd>@context.Name</MudTd>
            <MudTd>@context.PhoneNumber</MudTd>
            <MudTd>@context.EmailAddress</MudTd>
            <MudTd Style="text-align:right;">
                <MudIconButton Disabled="isLoading" Size="Size.Small" Icon="@Icons.Material.Filled.Edit" OnClick="@(() => StartEdit(context))" Class="ml-auto"/>
                <MudIconButton Disabled="isLoading" Size="Size.Small" Icon="@Icons.Material.Filled.Delete" OnClick="@(() => Delete(context))" Class="ml-auto"/>
            </MudTd>
        </RowTemplate>
    </MudTable>
}
else
{
    <MudPaper Elevation="0" Width="1200px;">
        <MudStack Row="true">
            <EditForm Model="@current" OnValidSubmit="@(() => Submit())">
                @if (pageState.Equals(PageState.Add))
                {
                    <MudText Typo="Typo.h5">Add Customer</MudText>
                }
                else if (pageState.Equals(PageState.Edit))
                {
                    <MudText Typo="Typo.h5">Edit Customer</MudText>
                    <MudTextField Margin="Margin.Dense" Style="width:300px;" ReadOnly="true" Variant="Variant.Outlined" Label="Id" @bind-Value="@current.Id" />
                }
                <DataAnnotationsValidator />
                <MudTextField Margin="Margin.Dense" Style="width:300px;" 
                              Variant="Variant.Outlined" 
                              For="@(() => current.Name)"
                              Label="Name" @bind-Value="@current.Name" />
                <MudTextField Margin="Margin.Dense" Style="width:300px;"
                              Variant="Variant.Outlined" 
                              HelperText="+373 xx xxx xxx"
                              Mask="@(new PatternMask("00 000 000"))"
                              For="@(() => current.PhoneNumber)"
                              Label="Phone Number" @bind-Value="@current.PhoneNumber" />
                <MudTextField Margin="Margin.Dense" Style="width:300px;"
                              Variant="Variant.Outlined" 
                              For="@(() => current.EmailAddress)"
                              Label="Email Address" @bind-Value="@current.EmailAddress" />
                <MudStack Row="true" Spacing="3">
                    <MudButton OnClick="@(() => Cancel())" Variant="Variant.Filled" Color="Color.Primary">Cancel</MudButton>
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">
                        @if (pageState.Equals(PageState.Add))
                        {
                            <MudText Typo="Typo.button">Add</MudText>
                        }
                        else if (pageState.Equals(PageState.Edit)) 
                        {
                            <MudText Typo="Typo.button">Edit</MudText>
                        }
                    </MudButton>
                </MudStack>
            </EditForm>
        </MudStack>
    </MudPaper>
}

@code {
    private PageState pageState;
    private bool isLoading = false;
    private List<CustomerEntity> customers = new List<CustomerEntity>();
    private Current current;
    public CronHandler cronHandler = default!;

    private class Current
    {
        public Current()
        {
        }

        public Current(CustomerEntity customer)
        {
            Id = customer.Id;
            Name = customer.Name;
            PhoneNumber = customer.PhoneNumber;
            EmailAddress = customer.EmailAddress;
        }

        public long Id { get; set; }

        [Required(ErrorMessage = "Name is required")]
        public string Name { get; set; } = string.Empty;

        [Required(ErrorMessage = "Phone Number is required")]
        [PhoneAttribute(ErrorMessage ="Phone number is invalid")]
        public string PhoneNumber { get; set; }

        [Required(ErrorMessage = "Email is required")]
        [EmailAddressAttribute(ErrorMessage = "The email address is invalid")]
        public string EmailAddress { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        pageState = PageState.Default;

        current = new Current();

        cronHandler = new CronHandler(Logger);

        var allCustomers = customerRepository.GetAll();
        customers = allCustomers.ToList();
        StateHasChanged();
    }

    private async Task Submit()
    {
        switch (pageState)
        {
            case PageState.Add: await Add(); break;
            case PageState.Edit: await ContinueEdit(); break;
        }
    }

    private async Task Add()
    {
        if (pageState.Equals(PageState.Default))
        {
            current = new Current();

            pageState = PageState.Add;
        }
        else if (pageState.Equals(PageState.Add))
        {
            var dialog = await OpenDialog(Dialog.ConfirmAdd);

            if (!dialog?.Canceled ?? false) 
            {
                try
                {
                    customerRepository.Add(new CustomerEntity() { Name = current.Name, PhoneNumber = current.PhoneNumber, EmailAddress = current.EmailAddress });
                    await UpdateLocalData();
                    pageState = PageState.Default;
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex.StackTrace + Environment.NewLine + ex.Message);
                }

                DisposeUI();
            }

        }

    }

    private void StartEdit(CustomerEntity entity)
    {
        if (pageState.Equals(PageState.Default))
        {
            current = new Current(entity);

            pageState = PageState.Edit;
        }
    }

    private async Task ContinueEdit()
    {
        if (pageState.Equals(PageState.Edit))
        {
            var dialog = await OpenDialog(Dialog.ConfirmEdit);

            if (!dialog?.Canceled ?? false)
            {
                try
                {
                    var entity = customers.FirstOrDefault(x => x.Id == current.Id);
                    if (entity != null)
                    {
                        entity.Name = current.Name;
                        entity.PhoneNumber = current.PhoneNumber;
                        entity.EmailAddress = current.EmailAddress;

                        customerRepository.Update(entity);

                        await UpdateLocalData();

                        pageState = PageState.Default;

                        DisposeUI();

                        StateHasChanged();
                    }
                }
                catch (Exception ex) 
                {
                    Logger.LogError(ex.StackTrace + Environment.NewLine + ex.Message);
                }

                DisposeUI();
            }
        }
    }

    private async Task Delete(CustomerEntity entity)
    {
        var dialog = await OpenDialog(Dialog.ConfirmDelete);

        if (!dialog?.Canceled ?? false)
        {
            customerRepository.Delete(entity);
            await UpdateLocalData();
        }
    }

    private async Task Cancel()
    {
        var dialog = await OpenDialog(Dialog.ConfirmCancel);

        if (!dialog?.Canceled ?? false)
        {
            pageState = PageState.Default;
            current = new Current();

            DisposeUI();
        }
    }

    private async Task Refresh()
    {
        await UpdateLocalData();
    }

    private async Task UpdateLocalData()
    {
        isLoading = true;
        var allCustomers = customerRepository.GetAll();
        customers = allCustomers.ToList();
        isLoading = false;

        await InvokeAsync(() => StateHasChanged());
    }

    private void DisposeUI()
    {
        pageState = PageState.Default;

        current = new Current();

        StateHasChanged();
    }

    public async Task<DialogResult?> OpenDialog(Enums.Dialog dialog)
    {
        IDialogReference window = default!;

        switch (dialog)
        {
            case Enums.Dialog.ConfirmAdd: window = await DialogService.ShowAsync<Dialogs.ConfirmAdd>(); break;
            case Enums.Dialog.ConfirmEdit: window = await DialogService.ShowAsync<Dialogs.ConfirmEdit>(); break;
            case Enums.Dialog.ConfirmDelete: window = await DialogService.ShowAsync<Dialogs.ConfirmDelete>(); break;
            case Enums.Dialog.ConfirmCancel: window = await DialogService.ShowAsync<Dialogs.ConfirmCancel>(); break;
        }

        var result = await window.Result;

        return result;
    }
}
