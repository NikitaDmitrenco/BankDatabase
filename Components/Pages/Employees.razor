@page "/employees"
@using BankDatabase
@using BankDatabase.Infostructure.Enums
@using BankDatabase.Infostructure.Entities
@using BankDatabase.Infostructure.Repositories
@using BankDatabase.Infostructure.Currents;
@using BankDatabase.Infostructure.Mappers;
@using System.ComponentModel.DataAnnotations
@rendermode InteractiveServer
@inject EmployeeRepository employeeRepository
@inject ILogger<Employees> Logger
@inject IDialogService DialogService

<MudDialogProvider />
<MudSnackbarProvider />

@if (pageState.Equals(PageState.Default))
{   
    <MudTable Items="entities" Hover="true" Elevation="0" 
              Dense="true" Square="true" Height="700" Loading="@isLoading" Style="width:1000px;">
        <ToolBarContent>
            <MudIconButton Disabled="isLoading" Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" OnClick="@(() => Refresh())"></MudIconButton>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Id</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Age</MudTh>
            <MudTh>Position</MudTh>
            <MudTh>PhoneNumber</MudTh>
            <MudTh>Address</MudTh>
            <MudTh Style="text-align:right;">
                <MudIconButton Disabled="isLoading" Icon="@Icons.Material.Filled.Add" Size="Size.Small" OnClick="@(() => Add())"/>
            </MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Id</MudTd>
            <MudTd>@context.Name</MudTd>
            <MudTd>@context.Age</MudTd>
            <MudTd>@context.Position</MudTd>
            <MudTd>@context.PhoneNumber</MudTd>
            <MudTd>@context.Address</MudTd>
            <MudTd Style="text-align:right;">
                <MudIconButton Disabled="isLoading" Size="Size.Small" Icon="@Icons.Material.Filled.Edit" OnClick="@(() => StartEdit(context))" Class="ml-auto"/>
                <MudIconButton Disabled="isLoading" Size="Size.Small" Icon="@Icons.Material.Filled.Delete" OnClick="@(() => Delete(context))" Class="ml-auto"/>
            </MudTd>
        </RowTemplate>
    </MudTable>
}
else
{
    <MudPaper Elevation="0" Width="1200px;">
        <MudStack Row="true">
            <EditForm Model="@current" OnValidSubmit="@(() => Submit())">
                @if (pageState.Equals(PageState.Add))
                {
                    <MudText Typo="Typo.h5">Add Employee</MudText>
                }
                else if (pageState.Equals(PageState.Edit))
                {
                    <MudText Typo="Typo.h5">Edit Employee</MudText>
                    <MudTextField Margin="Margin.Dense" Style="width:300px;" ReadOnly="true" Variant="Variant.Outlined" Label="Id" @bind-Value="@current.Id" />
                }
                <DataAnnotationsValidator />
                <MudTextField Margin="Margin.Dense" Style="width:300px;" 
                              Variant="Variant.Outlined" Label="Name" 
                              For="@(() => current.Name)"
                              @bind-Value="@current.Name" />
                <MudTextField Margin="Margin.Dense" Style="width:300px;"
                              Variant="Variant.Outlined" 
                              For="@(() => current.Age)"
                              Label="Age" @bind-Value="@current.Age" />
                <MudTextField Margin="Margin.Dense" Style="width:300px;"
                              Variant="Variant.Outlined" 
                              For="@(() => current.Position)"
                              Label="Position" @bind-Value="@current.Position" />
                <MudTextField Margin="Margin.Dense" Style="width:300px;"
                              Variant="Variant.Outlined"
                              HelperText="+373 xx xxx xxx"
                              Mask="@(new PatternMask("00 000 000"))"
                              For="@(() => current.PhoneNumber)"
                              Label="Phone Number" @bind-Value="@current.PhoneNumber" />
                <MudTextField Margin="Margin.Dense" Style="width:300px;"
                              Variant="Variant.Outlined" 
                              For="@(() => current.Address)"
                              Label="Address" @bind-Value="@current.Address" />
                <MudStack Row="true" Spacing="3">
                    <MudButton OnClick="@(() => Cancel())" Variant="Variant.Filled" Color="Color.Primary">Cancel</MudButton>
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">
                        @if (pageState.Equals(PageState.Add))
                        {
                            <MudText Typo="Typo.button">Add</MudText>
                        }
                        else if (pageState.Equals(PageState.Edit)) 
                        {
                            <MudText Typo="Typo.button">Edit</MudText>
                        }
                    </MudButton>
                </MudStack>
            </EditForm>
        </MudStack>
    </MudPaper>
}


@code {
    private PageState pageState;
    private bool isLoading = false;
    private List<EmployeeEntity> entities = new List<EmployeeEntity>();
    private CurrentEmployee current = new CurrentEmployee();
    public EmployeeMapper mapper = new EmployeeMapper();

    protected override async Task OnInitializedAsync()
    {
        pageState = PageState.Default;

        await UpdateLocalData();

        StateHasChanged();
    }

    private async Task Submit()
    {
        switch (pageState)
        {
            case PageState.Add: await Add(); break;
            case PageState.Edit: await ContinueEdit(); break;
        }
    }

    private async Task Add()
    {
        if (pageState.Equals(PageState.Default))
        {
            pageState = PageState.Add;
        }
        else if (pageState.Equals(PageState.Add))
        {
            var dialog = await OpenDialog(Dialog.ConfirmAdd);

            if (!dialog?.Canceled ?? false) 
            {
                try
                {
                    var entity = new EmployeeEntity();
                    mapper.ApplyToEntity(entity, current);

                    employeeRepository.Add(entity);

                    await UpdateLocalData();
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex.StackTrace + Environment.NewLine + ex.Message);
                }

                DisposeUI();
            }

        }

    }

    private void StartEdit(EmployeeEntity entity)
    {
        if (pageState.Equals(PageState.Default))
        {
            current = mapper.ToCurrent(entity);

            pageState = PageState.Edit;
        }
    }

    private async Task ContinueEdit()
    {
        if (pageState.Equals(PageState.Edit))
        {
            var dialog = await OpenDialog(Dialog.ConfirmEdit);

            if (!dialog?.Canceled ?? false)
            {
                try
                {
                    var entity = entities.First(x => x.Id == current.Id);

                    mapper.ApplyToEntity(entity, current);

                    employeeRepository.Update(entity);

                    await UpdateLocalData();

                    StateHasChanged();
                }
                catch (Exception ex) 
                {
                    Logger.LogError(ex.StackTrace + Environment.NewLine + ex.Message);
                }

                DisposeUI();
            }
        }
    }

    private async Task Delete(EmployeeEntity entity)
    {
        var dialog = await OpenDialog(Dialog.ConfirmDelete);

        if (!dialog?.Canceled ?? false)
        {
            employeeRepository.Delete(entity);
            await UpdateLocalData();
        }
    }

    private async Task Cancel()
    {
        var dialog = await OpenDialog(Dialog.ConfirmCancel);

        if (!dialog?.Canceled ?? false)
        {
            DisposeUI();
        }
    }

    private async Task Refresh()
    {
        await UpdateLocalData();

        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateLocalData()
    {
        isLoading = true;

        entities = employeeRepository.GetAll();

        isLoading = false;

        await InvokeAsync(StateHasChanged);
    }

    private void DisposeUI()
    {
        pageState = PageState.Default;

        current = new CurrentEmployee();

        StateHasChanged();
    }

    public async Task<DialogResult?> OpenDialog(Dialog dialog)
    {
        IDialogReference window = default!;

        switch (dialog)
        {
            case Dialog.ConfirmAdd: window = await DialogService.ShowAsync<Dialogs.ConfirmAdd>(); break;
            case Dialog.ConfirmEdit: window = await DialogService.ShowAsync<Dialogs.ConfirmEdit>(); break;
            case Dialog.ConfirmDelete: window = await DialogService.ShowAsync<Dialogs.ConfirmDelete>(); break;
            case Dialog.ConfirmCancel: window = await DialogService.ShowAsync<Dialogs.ConfirmCancel>(); break;
        }

        var result = await window.Result;

        return result;
    }
}
